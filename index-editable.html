<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FieldQuote AI - Editable Estimates</title>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .damage-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .damage-type {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .damage-type:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .damage-type.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        }

        .damage-type .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .photo-upload {
            border: 2px dashed #e5e7eb;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-upload:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .photo-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .photo-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
        }

        /* Results Section */
        .results-section {
            margin-top: 40px;
            padding: 30px;
            background: #f9fafb;
            border-radius: 15px;
        }

        .edit-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .edit-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: #e5e7eb;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 11px;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        .quick-adjustments {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .adjustment-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .adjustment-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        .adjustment-buttons {
            display: flex;
            gap: 5px;
        }

        .adjustment-btn {
            padding: 5px 10px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .adjustment-btn:hover {
            border-color: #667eea;
            background: #f3f4f6;
        }

        .adjustment-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .line-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .line-items-table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
        }

        .line-items-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .editable-input {
            width: 80px;
            padding: 5px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-btn {
            width: 24px;
            height: 24px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .quantity-btn:hover {
            background: #f3f4f6;
            border-color: #667eea;
        }

        .delete-btn {
            color: #ef4444;
            cursor: pointer;
            padding: 5px;
        }

        .delete-btn:hover {
            color: #dc2626;
        }

        .totals-section {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .total-row:last-child {
            border-bottom: none;
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
        }

        .add-item-btn {
            margin-top: 15px;
            padding: 10px 20px;
            border: 2px dashed #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .add-item-btn:hover {
            background: #667eea;
            color: white;
        }

        .save-section {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 10px;
            text-align: center;
        }

        .save-btn {
            padding: 15px 40px;
            font-size: 18px;
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal for adding custom line items */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            color: #374151;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è FieldQuote AI</h1>
            <p>Professional Restoration Estimates with AI Analysis</p>
        </div>

        <div class="content">
            <!-- Damage Type Selection -->
            <div class="damage-selector">
                <div class="damage-type" onclick="selectDamage('water')" data-type="water">
                    <div class="icon">üíß</div>
                    <h3>Water Damage</h3>
                    <p>Flooding, leaks, burst pipes</p>
                </div>
                <div class="damage-type" onclick="selectDamage('fire')" data-type="fire">
                    <div class="icon">üî•</div>
                    <h3>Fire Damage</h3>
                    <p>Fire, smoke, soot damage</p>
                </div>
                <div class="damage-type" onclick="selectDamage('mold')" data-type="mold">
                    <div class="icon">ü¶†</div>
                    <h3>Mold Remediation</h3>
                    <p>Mold growth, moisture issues</p>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="form-section">
                <h2>Customer Information</h2>
                <div class="form-group">
                    <label for="customer-name">Customer Name *</label>
                    <input type="text" id="customer-name" name="customerName" placeholder="John Smith" required>
                </div>
                <div class="form-group">
                    <label for="customer-email">Email</label>
                    <input type="email" id="customer-email" name="customerEmail" placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label for="customer-phone">Phone</label>
                    <input type="tel" id="customer-phone" name="customerPhone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label for="property-address">Property Address *</label>
                    <input type="text" id="property-address" name="propertyAddress" placeholder="123 Main St, York, PA 17401" required>
                </div>
            </div>

            <!-- Photo Upload -->
            <div class="form-section">
                <h2>Damage Photos</h2>
                <div class="photo-upload" onclick="document.getElementById('photo-input').click()">
                    <p>üì∑ Click to upload photos</p>
                    <p style="color: #6b7280; margin-top: 10px;">or drag and drop</p>
                </div>
                <input type="file" id="photo-input" multiple accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                <div class="photo-preview" id="photo-preview"></div>
            </div>

            <!-- Generate Estimate Button -->
            <button class="btn btn-primary" onclick="generateEstimate()">
                Generate AI Estimate
            </button>

            <!-- Results Section (Initially Hidden) -->
            <div class="results-section" id="results-section" style="display: none;">
                <div class="edit-controls">
                    <div class="edit-toggle">
                        <span>Edit Mode</span>
                        <div class="toggle-switch" id="edit-toggle" onclick="toggleEditMode()"></div>
                    </div>

                    <div class="quick-adjustments" id="quick-adjustments" style="display: none;">
                        <div class="adjustment-group">
                            <span class="adjustment-label">Labor Rate</span>
                            <div class="adjustment-buttons">
                                <button class="adjustment-btn" onclick="setLaborRate(85)">$85</button>
                                <button class="adjustment-btn active" onclick="setLaborRate(125)">$125</button>
                                <button class="adjustment-btn" onclick="setLaborRate(150)">$150</button>
                                <button class="adjustment-btn" onclick="setCustomLaborRate()">Custom</button>
                            </div>
                        </div>

                        <div class="adjustment-group">
                            <span class="adjustment-label">Equipment Days</span>
                            <div class="adjustment-buttons">
                                <button class="adjustment-btn active" onclick="setEquipmentDays(3)">3</button>
                                <button class="adjustment-btn" onclick="setEquipmentDays(5)">5</button>
                                <button class="adjustment-btn" onclick="setEquipmentDays(7)">7</button>
                                <button class="adjustment-btn" onclick="setCustomEquipmentDays()">Custom</button>
                            </div>
                        </div>

                        <div class="adjustment-group">
                            <span class="adjustment-label">Markup</span>
                            <div class="adjustment-buttons">
                                <button class="adjustment-btn active" onclick="setMarkup(0)">None</button>
                                <button class="adjustment-btn" onclick="setMarkup(10)">+10%</button>
                                <button class="adjustment-btn" onclick="setMarkup(25)">+25%</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Line Items Table -->
                <table class="line-items-table" id="line-items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                            <th id="action-column" style="display: none;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="line-items-body">
                        <!-- Line items will be inserted here -->
                    </tbody>
                </table>

                <button class="add-item-btn" id="add-item-btn" style="display: none;" onclick="showAddItemModal()">
                    + Add Custom Line Item
                </button>

                <!-- Totals Section -->
                <div class="totals-section">
                    <div class="total-row">
                        <span>Original AI Estimate:</span>
                        <span id="original-total">$0.00</span>
                    </div>
                    <div class="total-row">
                        <span>Adjustments:</span>
                        <span id="adjustments">$0.00</span>
                    </div>
                    <div class="total-row">
                        <span>Adjusted Total:</span>
                        <span id="adjusted-total">$0.00</span>
                    </div>
                </div>

                <!-- Save Section -->
                <div class="save-section">
                    <button class="btn btn-primary save-btn" onclick="saveEstimate()">
                        üíæ Save Estimate to Database
                    </button>
                    <button class="btn btn-success save-btn" onclick="generatePDF()" style="margin-left: 10px;">
                        üìÑ Generate PDF Report
                    </button>
                    <button class="btn btn-info save-btn" onclick="emailEstimate()" style="margin-left: 10px; display: none;" id="email-btn">
                        üìß Email to Customer
                    </button>
                    <div class="status-message" id="status-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Adding Custom Line Items -->
    <div class="modal" id="add-item-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Custom Line Item</h3>
            </div>
            <div class="form-group">
                <label for="item-description">Description</label>
                <input type="text" id="item-description" placeholder="e.g., Additional drying equipment">
            </div>
            <div class="form-group">
                <label for="item-quantity">Quantity</label>
                <input type="number" id="item-quantity" min="1" value="1">
            </div>
            <div class="form-group">
                <label for="item-unit">Unit</label>
                <select id="item-unit">
                    <option value="each">Each</option>
                    <option value="sqft">Sq Ft</option>
                    <option value="lf">Linear Ft</option>
                    <option value="hour">Hour</option>
                    <option value="day">Day</option>
                </select>
            </div>
            <div class="form-group">
                <label for="item-price">Unit Price</label>
                <input type="number" id="item-price" min="0" step="0.01" placeholder="0.00">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddItemModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addCustomLineItem()">Add Item</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // Replace with your Supabase anon key
        
        let supabase = null;
        
        // Only initialize Supabase if credentials are provided
        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // Create element ID aliases for compatibility
        window.addEventListener('DOMContentLoaded', function() {
            // Map alternative IDs to existing elements
            const idMappings = {
                'customerName': 'customer-name',
                'customerEmail': 'customer-email',
                'customerPhone': 'customer-phone',
                'propertyAddress': 'property-address',
                'customer-address': 'property-address',
                'customerAddress': 'property-address'
            };
            
            // Store original getElementById
            const originalGetElementById = document.getElementById.bind(document);
            
            // Override getElementById to handle aliases
            document.getElementById = function(id) {
                let element = originalGetElementById(id);
                if (!element && idMappings[id]) {
                    element = originalGetElementById(idMappings[id]);
                }
                return element;
            };
        });

        // Global state
        let selectedDamageType = null;
        let uploadedPhotos = [];
        let currentEstimate = null;
        let currentAnalysis = null;  // Store AI analysis results
        let currentLineItems = [];  // Store line items from analysis
        let editMode = false;
        let lineItems = [];
        let originalTotal = 0;
        let adjustedTotal = 0;
        let laborRate = 125;
        let equipmentDays = 3;
        let markupPercent = 0;

        // Select damage type
        function selectDamage(type) {
            selectedDamageType = type;
            document.querySelectorAll('.damage-type').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
        }

        // Handle photo upload
        function handlePhotoUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('photo-preview');
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    uploadedPhotos.push(file);
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // Generate estimate (mock for now)
        async function generateEstimate() {
            if (!selectedDamageType) {
                alert('Please select a damage type');
                return;
            }

            const customerName = document.getElementById('customer-name').value;
            const propertyAddress = document.getElementById('property-address').value;

            if (!customerName || !propertyAddress) {
                alert('Please fill in required fields');
                return;
            }

            // Mock AI analysis result
            currentEstimate = generateMockEstimate(selectedDamageType);
            // Set currentAnalysis and currentLineItems for PDF generation
            currentAnalysis = {
                damage_type: selectedDamageType,
                severity: 'moderate',
                affected_area_sqft: 500,
                equipment_needed: [],
                line_items: currentEstimate.lineItems
            };
            currentLineItems = currentEstimate.lineItems || [];
            displayEstimate(currentEstimate);
        }

        // Generate mock estimate based on damage type
        function generateMockEstimate(damageType) {
            const estimates = {
                water: {
                    lineItems: [
                        { description: 'Water extraction', quantity: 500, unit: 'sqft', unitPrice: 1.50, category: 'Mitigation' },
                        { description: 'Drying equipment rental', quantity: 3, unit: 'day', unitPrice: 150, category: 'Equipment' },
                        { description: 'Moisture monitoring', quantity: 4, unit: 'hour', unitPrice: 85, category: 'Labor' },
                        { description: 'Antimicrobial treatment', quantity: 500, unit: 'sqft', unitPrice: 0.75, category: 'Materials' },
                        { description: 'Dehumidifier rental', quantity: 3, unit: 'day', unitPrice: 85, category: 'Equipment' }
                    ]
                },
                fire: {
                    lineItems: [
                        { description: 'Soot removal', quantity: 800, unit: 'sqft', unitPrice: 2.50, category: 'Cleaning' },
                        { description: 'Odor treatment', quantity: 800, unit: 'sqft', unitPrice: 1.25, category: 'Treatment' },
                        { description: 'Air scrubber rental', quantity: 5, unit: 'day', unitPrice: 125, category: 'Equipment' },
                        { description: 'Content cleaning', quantity: 8, unit: 'hour', unitPrice: 95, category: 'Labor' },
                        { description: 'HEPA vacuuming', quantity: 800, unit: 'sqft', unitPrice: 0.50, category: 'Cleaning' }
                    ]
                },
                mold: {
                    lineItems: [
                        { description: 'Containment setup', quantity: 200, unit: 'sqft', unitPrice: 3.00, category: 'Setup' },
                        { description: 'Mold removal', quantity: 200, unit: 'sqft', unitPrice: 5.00, category: 'Remediation' },
                        { description: 'HEPA filtration', quantity: 3, unit: 'day', unitPrice: 150, category: 'Equipment' },
                        { description: 'Post-remediation cleaning', quantity: 200, unit: 'sqft', unitPrice: 2.00, category: 'Cleaning' },
                        { description: 'Air quality testing', quantity: 2, unit: 'test', unitPrice: 350, category: 'Testing' }
                    ]
                }
            };

            return estimates[damageType] || estimates.water;
        }

        // Display estimate
        function displayEstimate(estimate) {
            lineItems = estimate.lineItems.map(item => ({
                ...item,
                total: item.quantity * item.unitPrice
            }));

            originalTotal = lineItems.reduce((sum, item) => sum + item.total, 0);
            adjustedTotal = originalTotal;

            updateLineItemsTable();
            updateTotals();

            document.getElementById('results-section').style.display = 'block';
        }

        // Update line items table
        function updateLineItemsTable() {
            const tbody = document.getElementById('line-items-body');
            tbody.innerHTML = '';

            lineItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.description}</td>
                    <td>
                        ${editMode ? `
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="adjustQuantity(${index}, -1)">-</button>
                                <input type="number" class="editable-input" value="${item.quantity}" 
                                       onchange="updateQuantity(${index}, this.value)">
                                <button class="quantity-btn" onclick="adjustQuantity(${index}, 1)">+</button>
                            </div>
                        ` : item.quantity}
                    </td>
                    <td>${item.unit}</td>
                    <td>
                        ${editMode ? `
                            $<input type="number" class="editable-input" value="${item.unitPrice.toFixed(2)}" 
                                   step="0.01" onchange="updateUnitPrice(${index}, this.value)">
                        ` : `$${item.unitPrice.toFixed(2)}`}
                    </td>
                    <td>$${item.total.toFixed(2)}</td>
                    ${editMode ? `
                        <td>
                            <span class="delete-btn" onclick="deleteLineItem(${index})">üóëÔ∏è</span>
                        </td>
                    ` : ''}
                `;
                tbody.appendChild(row);
            });
        }

        // Toggle edit mode
        function toggleEditMode() {
            editMode = !editMode;
            const toggle = document.getElementById('edit-toggle');
            toggle.classList.toggle('active');
            
            document.getElementById('quick-adjustments').style.display = editMode ? 'flex' : 'none';
            document.getElementById('action-column').style.display = editMode ? 'table-cell' : 'none';
            document.getElementById('add-item-btn').style.display = editMode ? 'block' : 'none';
            
            updateLineItemsTable();
        }

        // Quantity adjustment functions
        function adjustQuantity(index, delta) {
            lineItems[index].quantity = Math.max(1, lineItems[index].quantity + delta);
            lineItems[index].total = lineItems[index].quantity * lineItems[index].unitPrice;
            recalculateTotal();
        }

        function updateQuantity(index, value) {
            lineItems[index].quantity = Math.max(1, parseFloat(value) || 1);
            lineItems[index].total = lineItems[index].quantity * lineItems[index].unitPrice;
            recalculateTotal();
        }

        function updateUnitPrice(index, value) {
            lineItems[index].unitPrice = Math.max(0, parseFloat(value) || 0);
            lineItems[index].total = lineItems[index].quantity * lineItems[index].unitPrice;
            recalculateTotal();
        }

        function deleteLineItem(index) {
            if (confirm('Delete this line item?')) {
                lineItems.splice(index, 1);
                recalculateTotal();
            }
        }

        // Quick adjustment functions
        function setLaborRate(rate) {
            laborRate = rate;
            updateLaborItems();
            highlightActiveButton('labor', rate);
        }

        function setCustomLaborRate() {
            const rate = prompt('Enter custom labor rate:', laborRate);
            if (rate && !isNaN(rate)) {
                laborRate = parseFloat(rate);
                updateLaborItems();
            }
        }

        function setEquipmentDays(days) {
            equipmentDays = days;
            updateEquipmentItems();
            highlightActiveButton('equipment', days);
        }

        function setCustomEquipmentDays() {
            const days = prompt('Enter equipment days:', equipmentDays);
            if (days && !isNaN(days)) {
                equipmentDays = parseInt(days);
                updateEquipmentItems();
            }
        }

        function setMarkup(percent) {
            markupPercent = percent;
            recalculateTotal();
            highlightActiveButton('markup', percent);
        }

        function highlightActiveButton(group, value) {
            // This would highlight the active button in the UI
            // Implementation depends on specific UI framework
        }

        function updateLaborItems() {
            lineItems.forEach(item => {
                if (item.category === 'Labor') {
                    item.unitPrice = laborRate;
                    item.total = item.quantity * item.unitPrice;
                }
            });
            recalculateTotal();
        }

        function updateEquipmentItems() {
            lineItems.forEach(item => {
                if (item.category === 'Equipment' && item.unit === 'day') {
                    item.quantity = equipmentDays;
                    item.total = item.quantity * item.unitPrice;
                }
            });
            recalculateTotal();
        }

        // Recalculate totals
        function recalculateTotal() {
            const subtotal = lineItems.reduce((sum, item) => sum + item.total, 0);
            adjustedTotal = subtotal * (1 + markupPercent / 100);
            updateLineItemsTable();
            updateTotals();
        }

        function updateTotals() {
            document.getElementById('original-total').textContent = `$${originalTotal.toFixed(2)}`;
            document.getElementById('adjustments').textContent = `$${(adjustedTotal - originalTotal).toFixed(2)}`;
            document.getElementById('adjusted-total').textContent = `$${adjustedTotal.toFixed(2)}`;
        }

        // Add custom line item modal functions
        function showAddItemModal() {
            document.getElementById('add-item-modal').style.display = 'flex';
        }

        function closeAddItemModal() {
            document.getElementById('add-item-modal').style.display = 'none';
            // Clear form
            document.getElementById('item-description').value = '';
            document.getElementById('item-quantity').value = '1';
            document.getElementById('item-unit').value = 'each';
            document.getElementById('item-price').value = '';
        }

        function addCustomLineItem() {
            const description = document.getElementById('item-description').value;
            const quantity = parseFloat(document.getElementById('item-quantity').value) || 1;
            const unit = document.getElementById('item-unit').value;
            const unitPrice = parseFloat(document.getElementById('item-price').value) || 0;

            if (!description || unitPrice <= 0) {
                alert('Please fill in all fields with valid values');
                return;
            }

            lineItems.push({
                description,
                quantity,
                unit,
                unitPrice,
                total: quantity * unitPrice,
                category: 'Custom'
            });

            recalculateTotal();
            closeAddItemModal();
        }

        // Save estimate to database
        async function saveEstimate() {
            if (!supabase) {
                showStatus('Database not configured. Please set up Supabase credentials.', 'error');
                return;
            }

            try {
                showStatus('Saving estimate...', 'info');

                // First, create or get contractor
                const contractor = await getOrCreateContractor();
                
                // Create job
                const jobData = {
                    contractor_id: contractor.id,
                    customer_name: document.getElementById('customer-name').value,
                    customer_email: document.getElementById('customer-email').value,
                    customer_phone: document.getElementById('customer-phone').value,
                    address: document.getElementById('property-address').value,
                    damage_type: selectedDamageType,
                    status: 'draft'
                };

                const { data: job, error: jobError } = await supabase
                    .from('jobs')
                    .insert([jobData])
                    .select()
                    .single();

                if (jobError) throw jobError;

                // Upload photos if any
                const photoUrls = await uploadPhotosToSupabase();

                // Save estimate
                const estimateData = {
                    job_id: job.id,
                    ai_analysis: {
                        damage_type: selectedDamageType,
                        analysis_date: new Date().toISOString()
                    },
                    line_items: lineItems,
                    original_total: originalTotal,
                    adjusted_total: adjustedTotal,
                    photos_urls: photoUrls,
                    labor_rate: laborRate,
                    equipment_days: equipmentDays,
                    markup_percent: markupPercent
                };

                const { data: estimate, error: estimateError } = await supabase
                    .from('estimates')
                    .insert([estimateData])
                    .select()
                    .single();

                if (estimateError) throw estimateError;

                showStatus('Estimate saved successfully!', 'success');
                
                // Optional: Generate PDF or redirect to view
                console.log('Saved estimate:', estimate);

            } catch (error) {
                console.error('Error saving estimate:', error);
                showStatus('Error saving estimate: ' + error.message, 'error');
            }
        }

        async function getOrCreateContractor() {
            // For demo purposes, use a default contractor
            // In production, this would be tied to the authenticated user
            const { data, error } = await supabase
                .from('contractors')
                .select()
                .eq('email', 'demo@fieldquote.com')
                .single();

            if (data) return data;

            // Create default contractor if doesn't exist
            const { data: newContractor, error: createError } = await supabase
                .from('contractors')
                .insert([{
                    business_name: 'Demo Restoration Services',
                    email: 'demo@fieldquote.com',
                    phone: '555-0100'
                }])
                .select()
                .single();

            if (createError) throw createError;
            return newContractor;
        }

        async function uploadPhotosToSupabase() {
            if (!uploadedPhotos.length) return [];

            const urls = [];
            for (const photo of uploadedPhotos) {
                const fileName = `${Date.now()}_${photo.name}`;
                const { data, error } = await supabase.storage
                    .from('damage-photos')
                    .upload(fileName, photo);

                if (!error && data) {
                    const { data: { publicUrl } } = supabase.storage
                        .from('damage-photos')
                        .getPublicUrl(fileName);
                    urls.push(publicUrl);
                }
            }
            return urls;
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';

            if (type !== 'info') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('add-item-modal');
            if (event.target === modal) {
                closeAddItemModal();
            }
        }
        // PDF Generation Functions
        let currentPDFData = null;
        let currentPDFFilename = null;

        async function generatePDF() {
            // Check if we have analysis data
            if (!currentAnalysis || !currentLineItems || currentLineItems.length === 0) {
                // Try to use lineItems if available
                if (lineItems && lineItems.length > 0) {
                    currentLineItems = lineItems;
                    if (!currentAnalysis) {
                        currentAnalysis = {
                            damage_type: selectedDamageType || 'water',
                            severity: 'moderate',
                            affected_area_sqft: 500,
                            equipment_needed: []
                        };
                    }
                } else {
                    alert('Please analyze damage photos first before generating a PDF');
                    return;
                }
            }
            
            // Safely get customer info with fallbacks
            const getElementValue = (id, defaultValue = '') => {
                const element = document.getElementById(id);
                return element ? element.value : defaultValue;
            };
            
            const customerInfo = {
                name: getElementValue('customerName', getElementValue('customer-name', 'Customer')),
                email: getElementValue('customerEmail', 'contact@example.com'),
                phone: getElementValue('customerPhone', '555-0000'),
                address: getElementValue('propertyAddress', getElementValue('property-address', getElementValue('customer-address', 'Address not provided')))
            };
            
            console.log('Generating PDF with:', {
                hasAnalysis: !!currentAnalysis,
                lineItemCount: currentLineItems.length,
                customerInfo: customerInfo
            });
            
            // Calculate total
            const total = currentLineItems.reduce((sum, item) => {
                const itemTotal = item.total || (item.quantity * item.unitPrice) || 0;
                return sum + parseFloat(itemTotal || 0);
            }, 0);
            
            // Call the PDF API
            try {
                const response = await fetch('/api/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        analysis: currentAnalysis,
                        lineItems: currentLineItems,
                        customerInfo: customerInfo,
                        totalAmount: total,
                        damageType: currentAnalysis.damage_type || 'water',
                        customer_name: customerInfo.name,
                        customer_address: customerInfo.address,
                        date: new Date().toLocaleDateString(),
                        job_number: 'EST-' + Date.now()
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `estimate_${Date.now()}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    alert('PDF generated successfully!');
                    if (typeof showStatus === 'function') {
                        showStatus('PDF generated successfully!', 'success');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    alert('Failed to generate PDF. Server error.');
                    if (typeof showStatus === 'function') {
                        showStatus('Failed to generate PDF', 'error');
                    }
                }
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('Error generating PDF. Please check the console for details.');
                if (typeof showStatus === 'function') {
                    showStatus(`Error generating PDF: ${error.message}`, 'error');
                }
            }
        }

        function getClassificationFromAnalysis(analysis) {
            const classification = {};
            
            if (analysis.damage_type === 'water') {
                classification.category = analysis.category;
                classification.class = analysis.class;
            } else if (analysis.damage_type === 'fire') {
                classification.damage_level = analysis.soot_level || 'moderate';
                classification.smoke_type = analysis.smoke_type || 'dry';
            } else if (analysis.damage_type === 'mold') {
                classification.condition = analysis.condition;
                classification.contamination_level = analysis.contamination_level;
            }
            
            return classification;
        }

        function getLineItemsFromTable() {
            const lineItems = [];
            const rows = document.querySelectorAll('#line-items-table tr');
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length >= 3) {
                    lineItems.push({
                        description: inputs[0].value,
                        quantity: parseFloat(inputs[1].value) || 0,
                        unit_price: parseFloat(inputs[2].value) || 0
                    });
                }
            });
            
            return lineItems;
        }

        function showPDFModal(pdfData) {
            const modal = document.getElementById('pdf-modal');
            const preview = document.getElementById('pdf-preview');
            
            // Set PDF data in iframe
            preview.src = pdfData;
            
            // Show modal
            modal.style.display = 'block';
        }

        function closePDFModal() {
            const modal = document.getElementById('pdf-modal');
            modal.style.display = 'none';
        }

        function downloadPDF() {
            if (!currentPDFData) {
                showStatus('No PDF to download', 'error');
                return;
            }

            // Create download link
            const link = document.createElement('a');
            link.href = currentPDFData;
            link.download = currentPDFFilename || 'estimate.pdf';
            link.click();
        }

        function emailPDF() {
            const customerEmail = prompt('Enter customer email address:');
            if (!customerEmail) return;

            const subject = encodeURIComponent('RestoreDoc - Your Restoration Estimate');
            const body = encodeURIComponent(`Dear ${document.getElementById('customer-name').value},\n\nPlease find attached your restoration estimate.\n\nFor any questions, please call us at 717-855-2367.\n\nBest regards,\nMajor Restoration Services\n\n[Please attach the PDF file: ${currentPDFFilename}]`);
            
            window.location.href = `mailto:${customerEmail}?subject=${subject}&body=${body}`;
            
            showStatus('Email client opened. Please attach the downloaded PDF.', 'info');
        }

        function emailEstimate() {
            if (currentPDFFilename) {
                emailPDF();
            } else {
                showStatus('Please generate PDF first', 'error');
            }
        }

        // Update window click handler to include PDF modal
        window.onclick = function(event) {
            const addModal = document.getElementById('add-item-modal');
            const pdfModal = document.getElementById('pdf-modal');
            
            if (event.target === addModal) {
                closeAddItemModal();
            } else if (event.target === pdfModal) {
                closePDFModal();
            }
        }
    </script>

    <!-- PDF Preview Modal -->
    <div class="modal" id="pdf-modal" style="display: none;">
        <div class="modal-content" style="max-width: 90%; width: 800px;">
            <div class="modal-header">
                <h2>PDF Preview</h2>
                <button onclick="closePDFModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="pdf-preview" style="width: 100%; height: 600px; border: 1px solid #e5e7eb; border-radius: 8px;"></iframe>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePDFModal()">Close</button>
                <button class="btn btn-primary" onclick="downloadPDF()">Download PDF</button>
                <button class="btn btn-info" onclick="emailPDF()">Email to Customer</button>
            </div>
        </div>
    </div>
</body>
</html>